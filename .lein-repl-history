    :description "Clojure Serial port (clj-serial 2.0.5)"
    :date_to "2023-02-01"
    :comment "написать код для чтения/записи в COM-порт + протоколы"
    :date_from "2023-12-11"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "project"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "clojure"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "serial"
  })
(out "status < 100")
;; #update#task
(jdbc/update!
  tsk
  :tasks
  {
    :status -10
    ;:complete_date "2023-12-07"
    ;:priority 20
    ;:date_to "2023-12-11"
    ;:description "9/030038 ОГЗ поверить"
    ;:comment "поверить с другим аккумулятором"
    ;:master_task 66
    ;:date_from ""
  }
  ["id = ?" 62])
(out "status < 100")
;; #tasks
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 90
    :description "Поиск приказов Росстандарта"
    :date_to "2023-02-01"
    :comment "Страничка с фильтрами"
    :date_from "2023-12-13"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 71
    :tag "project"
  })
(out "status < 100 and status >= 0")
;; #tasks
(out "status < 100 and status >= 0
      and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0
      and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0
      --and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0")
(defn get-data
  ""
  ([where order-by limit]
    (jdbc/query
      tsk
      (string/join "\n"
        (list
           "select
              *,
              group_concat(tag, ' ') as tags
            from view_tasks
            left join
              tags
              on view_tasks.id = tags.task_id"
           (if-not-blank where)
           "group by id"
           (if-not-blank order-by)
           (if-not-blank limit)))))
  ([where order-by]
    (get-data where order-by ""))
  ([where]
    (get-data where "priority, coalesce(master_task, id)" "")))
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      --and status >= 0")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0
      and tags like '%project%'")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0
      --and tags like '%project%'")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task 66
    :priority 4
    :description "Подготовить рабочее место"
    :date_to "2023-12-15"
    :comment nil
    :date_from "2023-12-14"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task 66
    :priority 5
    :description "Подготовить баллоны"
    :date_to "2023-12-15"
    :comment nil
    :date_from "2023-12-14"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #complete/task
(complete 67 "2023-12-14")
(out "status < 100 and status >= 0")
exit
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 80
    :description "Скрипт копирования ГРСИ с ФИФ."
    :date_to "2023-12-29"
    :comment nil
    :date_from "2023-12-20"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
(ns tasks.lib.tasks-db
  (:require 
    [clojure.java.jdbc :as jdbc]
    [clojure.string :as string]
    [clojure.pprint :refer [pprint]]
    [clojure.java.shell :refer [sh]]
    [tasks.view.report :as report]))
(def tsk
  {:classname "org.sqlite.jdbc"
   :subprotocol "sqlite"
   :subname "data/tasks.db"}) 
(defmacro if-not-blank
  [sym]
  `(if (not (string/blank? ~sym))
       (str ~(string/replace
               sym
               "-" 
               " ")
            " "
            ~sym)
       ""))
(defn get-data
  ""
  ([where order-by limit]
    (jdbc/query
      tsk
      (string/join "\n"
        (list
           "select
              *,
              group_concat(tag, ' ') as tags
            from view_tasks
            left join
              tags
              on view_tasks.id = tags.task_id"
           (if-not-blank where)
           "group by id"
           (if-not-blank order-by)
           (if-not-blank limit)))))
  ([where order-by]
    (get-data where order-by ""))
  ([where]
    (get-data where "priority, coalesce(master_task, id)" "")))
(defn complete
  ""
  ([id date s]
   (jdbc/update!
    tsk
    :tasks
    {:status 100
     :complete_date date
     :comment s}
    ["id = ?" id]))
  ([id date]
   (complete id date nil)))
(defn out
  [s]
  (spit
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"
    (report/tasks-report
      (get-data s)))
  #_(sh
    "vivaldi"
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"))
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 80
    :description "Скрипт копирования ГРСИ с ФИФ."
    :date_to "2023-12-29"
    :comment nil
    :date_from "2023-12-20"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 74
    :tag "project"
  })
(out "status < 100 and status >= 0")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 74
    :tag "arshin"
  })
(out "status < 100 and status >= 0")
;; #complete/task
(complete 69 "2023-12-14")
(out "status < 100 and status >= 0")
;; #complete/task
(complete 73 "2023-12-15")
(out "status < 100 and status >= 0")
;; #complete/task
(complete 72 "2023-12-15")
(out "status < 100 and status >= 0")
;; #complete/task
(complete 61 "2023-12-20")
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 1
    :description "Выгрузить записи из журнала ПР."
    :date_to "2023-12-21"
    :comment nil
    :date_from "2023-12-20"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #complete/task
(complete 75 "2023-12-21")
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 1
    :description "Поверка 20.12.2023."
    :date_to "2023-12-21"
    :comment nil
    :date_from "2023-12-20"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
(defn add-tags
  [id tags]
  (map (fn [s]
           (jdbc/insert!
             tsk
             :tags
             {:task_id id
              :tag s}))
       tags))
(add-tags 76 (list "verification"))
;; #tasks
(out "status < 100 and status >= 0")
(defn last-id
  []
  (jdbc/query
    tsk
    "select id from tasks order by id asc limit 1;"))
(last-id)
(defn last-id
  []
  (0 (jdbc/query
    tsk
    "select id from tasks order by id asc limit 1;")))
(last-id)
(defn last-id
  []
  (:id (first (jdbc/query
    tsk
    "select id from tasks order by id asc limit 1;"))))
(last-id)
;; #complete/task
(complete 76 "2023-12-21")
(out "status < 100 and status >= 0")
exit
(ns tasks.lib.tasks-db
  (:require 
    [clojure.java.jdbc :as jdbc]
    [clojure.string :as string]
    [clojure.pprint :refer [pprint]]
    [clojure.java.shell :refer [sh]]
    [tasks.view.report :as report]))
(def tsk
  {:classname "org.sqlite.jdbc"
   :subprotocol "sqlite"
   :subname "data/tasks.db"}) 
(defmacro if-not-blank
  [sym]
  `(if (not (string/blank? ~sym))
       (str ~(string/replace
               sym
               "-" 
               " ")
            " "
            ~sym)
       ""))
(defn get-data
  ""
  ([where order-by limit]
    (jdbc/query
      tsk
      (string/join "\n"
        (list
           "select
              *,
              group_concat(tag, ' ') as tags
            from view_tasks
            left join
              tags
              on view_tasks.id = tags.task_id"
           (if-not-blank where)
           "group by id"
           (if-not-blank order-by)
           (if-not-blank limit)))))
  ([where order-by]
    (get-data where order-by ""))
  ([where]
    (get-data where "priority, coalesce(master_task, id)" "")))
(defn complete
  ""
  ([id date s]
   (jdbc/update!
    tsk
    :tasks
    {:status 100
     :complete_date date
     :comment s}
    ["id = ?" id]))
  ([id date]
   (complete id date nil)))
(defn add-tags
  [id tags]
  (map (fn [s]
           (jdbc/insert!
             tsk
             :tags
             {:task_id id
              :tag s}))
       tags))
(defn out
  [s]
  (spit
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"
    (report/tasks-report
      (get-data s)))
  #_(sh
    "vivaldi"
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"))
(defn last-id
  []
  (:id
    (first
      (jdbc/query
        tsk
        "select id from tasks order by id asc limit 1;"))))
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 1
    :description "Поверка хроматографы ОГЗ."
    :date_to "2023-12-25"
    :comment nil
    :date_from "2023-12-25"
    :status 0
    ;:complete_date "2023-12-07"
  })
(add-tags
  (last-id) 
  (list verification))
(out "status < 100 and status >= 0")
;; #delete/task
(jdbc/delete!
  tsk
  :tasks
  ["id = ?" 77])
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 1
    :description "Поверка хроматографы ОГЗ."
    :date_to "2023-12-25"
    :comment nil
    :date_from "2023-12-25"
    :status 0
    ;:complete_date "2023-12-07"
  })
(add-tags
  (last-id) 
  (list "verification"))
(out "status < 100 and status >= 0")
(last-id)
(defn last-id
  []
  (:id
    (first
      (jdbc/query
        tsk
        "select id from tasks order by id desc limit 1;"))))
(last-id)
;; #tasks
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task nil
    :priority 1
    :description "Поверка 29.12.2023."
    :date_to "2024-01-09"
    :comment nil
    :date_from "2023-12-29"
    :status 0
    ;:complete_date "2023-12-07"
  })
(add-tags
  (last-id) 
  (list "verification"))
(out "status < 100 and status >= 0")
