;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 59
    :tag "project"
  })
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 59
    :priority 1
    :description "Подготовка к РОА"
    :date_to "2023-12-18"
    :comment nil
    :date_from "2023-12-08"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #update#task
(jdbc/update!
  tsk
  :tasks
  {
    ;:status 100
    ;:complete_date "2023-12-07"
    ;:priority 20
    ;:date_to "2023-12-11"
    ;:description "9/030038 ОГЗ поверить"
    ;:comment "поверить с другим аккумулятором"
    :master_task 66
    ;:date_from ""
  }
  ["id = ?" 56])
(out "status < 100")
;; #update#task
(jdbc/update!
  tsk
  :tasks
  {
    ;:status 100
    ;:complete_date "2023-12-07"
    ;:priority 20
    ;:date_to "2023-12-11"
    ;:description "9/030038 ОГЗ поверить"
    ;:comment "поверить с другим аккумулятором"
    :master_task 66
    ;:date_from ""
  }
  ["id = ?" 61])
(out "status < 100")
;; #delete/task
(jdbc/delete!
  tsk
  :tasks
  ["id = ?" 56])
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 60
    :tag "verification"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 66
    :tag "audit"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 61
    :tag "audit"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 1
    :tag "verification"
  })
(out "status < 100")
;; #tasks
(out "status < 100")
;; #tasks
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task 66
    :priority 1
    :description "Вступительное слово"
    :date_to "2023-12-18"
    :comment nil
    :date_from "2023-12-08"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 1
    :description "Проверить выгрузку 9/029777 ОГЗ"
    :date_to "2023-12-11"
    :comment "Исправлены ошибочные данные о результатах поверки"
    :date_from "2023-12-08"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 68
    :tag "verification"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 68
    :tag "check"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 68
    :tag "arshin"
  })
(out "status < 100")
(require '[tasks.view.report :as report] :reload)
(out "status < 100")
exit
(ns tasks.lib.tasks-db
  (:require 
    [clojure.java.jdbc :as jdbc]
    [clojure.string :as string]
    [clojure.pprint :refer [pprint]]
    [clojure.java.shell :refer [sh]]
    [tasks.view.report :as report]))
(def tsk
  {:classname "org.sqlite.jdbc"
   :subprotocol "sqlite"
   :subname "data/tasks.db"}) 
(defmacro if-not-blank
  [sym]
  `(if (not (string/blank? ~sym))
       (str ~(string/replace
               sym
               "-" 
               " ")
            " "
            ~sym)
       ""))
(defn get-data
  ""
  ([where order-by limit]
    (jdbc/query
      tsk
      (string/join " "
        (list
           "select
              *,
              group_concat(tag, ' ') as tags
            from view_tasks
            left join
              tags
              on view_tasks.id = tags.task_id"
           (if-not-blank where)
           "group by id"
           (if-not-blank order-by)
           (if-not-blank limit)))))
  ([where order-by]
    (get-data where order-by ""))
  ([where]
    (get-data where "priority, coalesce(master_task, id)" "")))
(defn out
  [s]
  (spit
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"
    (report/tasks-report
      (get-data s)))
  #_(sh
    "vivaldi"
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html"))
;; #tasks
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 1
    :description "Проверить выгрузку 9/029777 ОГЗ"
    :date_to "2023-12-11"
    :comment "Исправлены ошибочные данные о результатах поверки"
    :date_from "2023-12-08"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #update#task
(jdbc/update!
  tsk
  :tasks
  {
    ;:status 100
    ;:complete_date "2023-12-07"
    ;:priority 20
    ;:date_to "2023-12-11"
    ;:description "9/030038 ОГЗ поверить"
    ;:comment "поверить с другим аккумулятором"
    :master_task 66
    ;:date_from ""
  }
  ["id = ?" 61])
(out "status < 100")
;; #delete/task
(jdbc/delete!
  tsk
  :tasks
  ["id = ?" 56])
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 68
    :tag "arshin"
  })
(out "status < 100")
(comment
(require '[tasks.view.report :as report] :reload)
(out "status < 100")
(require '[clojure.repl :refer :all])
(dir clojure.string)
(* (- 2.13 (* 1.33 0.966)) 0.01 0.966)
(- 2.13 (* 1.33 0.966))
)
;; #tasks
(out "status < 100")
(sh
    "vivaldi"
    "/media/sf_YandexDisk/Ermolaev/midb/tasks.html")
;; #delete/task
(jdbc/delete!
  tsk
  :tasks
  ["id = ?" 69])
(out "status < 100")
(java.until.Date.)
(java.util.Date.)
(java.util/date java.util.Date.)
(dir java.util)
(require '[clojure.repl :refer :all])
(dir java.util)
(dir java.util.Date)
(defn complete
  ""
  ([id date s]
   (jdbc/update!
    tsk
    :tasks
    {:status 100
     :date date
     :comment s}
    ["id = ?" id]))
  ([id date]
   (complete id date nil)))
;; #complete/task
(complete 68 "2023-12-11")
(out "status < 100")
(defn complete
  ""
  ([id date s]
   (jdbc/update!
    tsk
    :tasks
    {:status 100
     :complete_date date
     :comment s}
    ["id = ?" id]))
  ([id date]
   (complete id date nil)))
;; #complete/task
(complete 68 "2023-12-11")
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 8
    :description "Посмотреть ХОББИТы «Уральский бройлер»"
    :date_to "2023-12-13"
    :comment nil
    :date_from "2023-12-11"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #complete/task
(complete 60 "2023-12-11")
(out "status < 100")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 90
    :description "Clojure Serial port (clj-serial 2.0.5)"
    :date_to "2023-02-01"
    :comment "написать код для чтения/записи в COM-порт + протоколы"
    :date_from "2023-12-11"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "project"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "clojure"
  })
(out "status < 100")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 70
    :tag "serial"
  })
(out "status < 100")
;; #update#task
(jdbc/update!
  tsk
  :tasks
  {
    :status -10
    ;:complete_date "2023-12-07"
    ;:priority 20
    ;:date_to "2023-12-11"
    ;:description "9/030038 ОГЗ поверить"
    ;:comment "поверить с другим аккумулятором"
    ;:master_task 66
    ;:date_from ""
  }
  ["id = ?" 62])
(out "status < 100")
;; #tasks
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    ;:master_task 66
    :priority 90
    :description "Поиск приказов Росстандарта"
    :date_to "2023-02-01"
    :comment "Страничка с фильтрами"
    :date_from "2023-12-13"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #add#tags
(jdbc/insert!
  tsk
  :tags
  {
    :task_id 71
    :tag "project"
  })
(out "status < 100 and status >= 0")
;; #tasks
(out "status < 100 and status >= 0
      and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0
      and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0
      --and tags like '%project%'")
;; #tasks
(out "status < 100 and status >= 0")
(defn get-data
  ""
  ([where order-by limit]
    (jdbc/query
      tsk
      (string/join "\n"
        (list
           "select
              *,
              group_concat(tag, ' ') as tags
            from view_tasks
            left join
              tags
              on view_tasks.id = tags.task_id"
           (if-not-blank where)
           "group by id"
           (if-not-blank order-by)
           (if-not-blank limit)))))
  ([where order-by]
    (get-data where order-by ""))
  ([where]
    (get-data where "priority, coalesce(master_task, id)" "")))
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      --and status >= 0")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0
      and tags like '%project%'")
(require '[tasks.view.report :as report] :reload)
(out "status < 100
      and status >= 0
      --and tags like '%project%'")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task 66
    :priority 4
    :description "Подготовить рабочее место"
    :date_to "2023-12-15"
    :comment nil
    :date_from "2023-12-14"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #add#task
(jdbc/insert!
  tsk
  :tasks
  {
    :master_task 66
    :priority 5
    :description "Подготовить баллоны"
    :date_to "2023-12-15"
    :comment nil
    :date_from "2023-12-14"
    :status 0
    ;:complete_date "2023-12-07"
  })
(out "status < 100 and status >= 0")
;; #complete/task
(complete 67 "2023-12-14")
(out "status < 100 and status >= 0")
